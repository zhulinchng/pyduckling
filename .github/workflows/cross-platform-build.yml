name: Cross-Platform Build and Test

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  release:
    types: [ published ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    name: Build Linux Wheels
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libpcre3-dev \
          libgmp-dev \
          pkg-config \
          curl \
          git \
          ghc \
          libghc-regex-compat-dev \
          libghc-syb-dev \
          libghc-old-locale-dev

    - name: Install Haskell Stack
      run: |
        if ! command -v stack >/dev/null 2>&1; then
          curl -sSL https://get.haskellstack.org/ | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
        else
          echo "Stack already installed at $(which stack)"
        fi

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
        
    - name: Cache Stack dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.stack
          duckling-ffi/.stack-work
        key: ${{ runner.os }}-stack-${{ hashFiles('duckling-ffi/stack.yaml.lock') }}
        restore-keys: |
          ${{ runner.os }}-stack-
          
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Build Duckling FFI
      run: |
        cd duckling-ffi
        # Set up environment for Haskell runtime libraries
        STACK_GHC_LIB_PATH="$HOME/.stack/programs/x86_64-linux/ghc-9.4.8/lib/ghc-9.4.8"
        export LD_LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LD_LIBRARY_PATH}"
        export LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LIBRARY_PATH}"

        # Try to use system GHC first, fallback to installing Stack's GHC if needed
        if command -v ghc >/dev/null 2>&1; then
          echo "Using system GHC"
          stack config set system-ghc --global true
          stack build --system-ghc --allow-different-user || {
            echo "System GHC failed, installing Stack's GHC..."
            stack setup
            export LD_LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LD_LIBRARY_PATH}"
            export LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LIBRARY_PATH}"
            stack build --allow-different-user
          }
        else
          echo "No system GHC found, installing Stack's GHC..."
          stack setup
          export LD_LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LD_LIBRARY_PATH}"
          export LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LIBRARY_PATH}"
          stack build --allow-different-user
        fi
        # Debug: List all files produced by the build
        echo "Files in duckling-ffi directory after build:"
        find . -type f -name "*.a" -o -name "*duckling*" -o -name "*lib*" | head -20
        # Find and copy the static library with robust search (built with -dynamic-too for PIC)
        find . -name "*.a" -type f -exec cp {} ../ext_lib/ \; 2>/dev/null || true
        # Also try to find any duckling-related static libraries
        find . -name "*duckling*.a" -type f -exec cp {} ../ext_lib/ \; 2>/dev/null || true
        # Also check for any library files that might be in subdirectories
        find . -name "*.a" -type f -exec echo "Found library: {}" \; 2>/dev/null || true
        # List what we found
        echo "Contents of ext_lib after copy:"
        ls -la ../ext_lib/
        # Ensure the expected library name exists
        if [ -f "../ext_lib/libducklingffi.a" ]; then
          echo "Found libducklingffi.a"
        else
          echo "libducklingffi.a not found, checking for alternatives..."
          find ../ext_lib/ -name "*.a" -exec echo "Found: {}" \;
          # If no static library found, this might indicate the build failed
          if [ ! -f "../ext_lib/libducklingffi.a" ] && [ ! -f "../ext_lib/libHSduckling-ffi-0.1.0.0*.a" ] && [ ! -f "../ext_lib/liba.a" ]; then
            echo "ERROR: No static library found! Haskell build may have failed."
            exit 1
          else
            echo "SUCCESS: Found Haskell static library!"
            # Create a symlink or copy with the expected name for Rust linking
            if [ -f "../ext_lib/libHSduckling-ffi-0.1.0.0*.a" ]; then
              HASKELL_LIB=$(find ../ext_lib/ -name "libHSduckling-ffi-0.1.0.0*.a" | head -1)
              echo "Found Haskell library: $HASKELL_LIB"
              ln -sf "$(basename "$HASKELL_LIB")" ../ext_lib/libducklingffi.a
              echo "Created symlink: libducklingffi.a -> $(basename "$HASKELL_LIB")"
            elif [ -f "../ext_lib/liba.a" ]; then
              echo "Found liba.a, copying to expected name..."
              cp ../ext_lib/liba.a ../ext_lib/libducklingffi.a
            fi
          fi
        fi
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install maturin pytest pytest-cov pendulum

    - name: Build Python package
      run: |
        python -m venv venv
        source venv/bin/activate
        # Ensure Haskell runtime libraries are available
        STACK_GHC_LIB_PATH="$HOME/.stack/programs/x86_64-linux/ghc-9.4.8/lib/ghc-9.4.8"
        export LD_LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LD_LIBRARY_PATH}"
        export LD_LIBRARY_PATH="/usr/lib/ghc-9.4.8/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
        export LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
        maturin develop --release

    - name: Run tests
      run: |
        source venv/bin/activate
        # Ensure Haskell runtime libraries are available for testing
        STACK_GHC_LIB_PATH="$HOME/.stack/programs/x86_64-linux/ghc-9.4.8/lib/ghc-9.4.8"
        export LD_LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LD_LIBRARY_PATH}"
        export LD_LIBRARY_PATH="/usr/lib/ghc-9.4.8/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
        export LD_LIBRARY_PATH="/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
        pytest -v duckling/tests/
        
    - name: Build wheel
      if: github.event_name == 'release'
      run: |
        source venv/bin/activate
        maturin build --release --out dist/
        
    - name: Upload wheels
      if: github.event_name == 'release'
      uses: actions/upload-artifact@v4
      with:
        name: linux-wheels-py${{ matrix.python-version }}
        path: dist/*.whl

  build-macos:
    name: Build macOS Wheels
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install Homebrew dependencies
      run: |
        brew install pcre gmp pkg-config haskell-stack ghc
        
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Set environment variables
      run: |
        echo "PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig:/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
        if [[ "$(uname -m)" == "arm64" || "$(uname -m)" == "aarch64" ]]; then
          echo "LIBRARY_PATH=/opt/homebrew/lib:$LIBRARY_PATH" >> $GITHUB_ENV
          echo "CPATH=/opt/homebrew/include:$CPATH" >> $GITHUB_ENV
        else
          echo "LIBRARY_PATH=/usr/local/lib:$LIBRARY_PATH" >> $GITHUB_ENV
          echo "CPATH=/usr/local/include:$CPATH" >> $GITHUB_ENV
        fi
        
    - name: Cache Stack dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.stack
          duckling-ffi/.stack-work
        key: ${{ runner.os }}-stack-${{ hashFiles('duckling-ffi/stack.yaml.lock') }}
        restore-keys: |
          ${{ runner.os }}-stack-
          
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Build Duckling FFI
      run: |
        cd duckling-ffi
        # Detect architecture and set paths
        ARCH=$(uname -m)
        if [[ "$ARCH" == "arm64" ]] || [[ "$ARCH" == "aarch64" ]]; then
          STACK_GHC_LIB_PATH="$HOME/.stack/programs/aarch64-osx/ghc-9.4.8/lib/ghc-9.4.8"
        else
          STACK_GHC_LIB_PATH="$HOME/.stack/programs/x86_64-osx/ghc-9.4.8/lib/ghc-9.4.8"
        fi

        # Set up environment for Haskell runtime libraries
        export DYLD_LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${DYLD_LIBRARY_PATH}"
        export LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LIBRARY_PATH}"

        # Try to use system GHC first, fallback to installing Stack's GHC if needed
        if command -v ghc >/dev/null 2>&1; then
          echo "Using system GHC"
          stack config set system-ghc --global true
          stack build --system-ghc --allow-different-user --force-dirty || {
            echo "System GHC failed, installing Stack's GHC..."
            stack setup
            export DYLD_LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${DYLD_LIBRARY_PATH}"
            export LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LIBRARY_PATH}"
            stack build --allow-different-user --force-dirty
          }
        else
          echo "No system GHC found, installing Stack's GHC..."
          stack setup
          export DYLD_LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${DYLD_LIBRARY_PATH}"
          export LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${LIBRARY_PATH}"
          stack build --allow-different-user --force-dirty
        fi
        # Debug: List all files produced by the build
        echo "Files in duckling-ffi directory after build:"
        find . -type f -name "*.a" -o -name "*duckling*" -o -name "*lib*" | head -20
        # Find and copy the static library with robust search (built with -dynamic-too for PIC)
        find . -name "*.a" -type f -exec cp {} ../ext_lib/ \; 2>/dev/null || true
        # Also try to find any duckling-related static libraries
        find . -name "*duckling*.a" -type f -exec cp {} ../ext_lib/ \; 2>/dev/null || true
        # Also check for any library files that might be in subdirectories
        find . -name "*.a" -type f -exec echo "Found library: {}" \; 2>/dev/null || true
        # List what we found
        echo "Contents of ext_lib after copy:"
        ls -la ../ext_lib/
        # Ensure the expected library name exists
        if [ -f "../ext_lib/libducklingffi.a" ]; then
          echo "Found libducklingffi.a"
        else
          echo "libducklingffi.a not found, checking for alternatives..."
          find ../ext_lib/ -name "*.a" -exec echo "Found: {}" \;
          # If no static library found, this might indicate the build failed
          if [ ! -f "../ext_lib/libducklingffi.a" ] && [ ! -f "../ext_lib/libHSduckling-ffi-0.1.0.0*.a" ] && [ ! -f "../ext_lib/liba.a" ]; then
            echo "ERROR: No static library found! Haskell build may have failed."
            exit 1
          else
            echo "SUCCESS: Found Haskell static library!"
            # Create a symlink or copy with the expected name for Rust linking
            if [ -f "../ext_lib/libHSduckling-ffi-0.1.0.0*.a" ]; then
              HASKELL_LIB=$(find ../ext_lib/ -name "libHSduckling-ffi-0.1.0.0*.a" | head -1)
              echo "Found Haskell library: $HASKELL_LIB"
              ln -sf "$(basename "$HASKELL_LIB")" ../ext_lib/libducklingffi.a
              echo "Created symlink: libducklingffi.a -> $(basename "$HASKELL_LIB")"
            elif [ -f "../ext_lib/liba.a" ]; then
              echo "Found liba.a, copying to expected name..."
              cp ../ext_lib/liba.a ../ext_lib/libducklingffi.a
            fi
          fi
        fi
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install maturin pytest pytest-cov pendulum

    - name: Build Python package
      run: |
        python -m venv venv
        source venv/bin/activate
        # Detect architecture and set paths
        ARCH=$(uname -m)
        if [[ "$ARCH" == "arm64" ]] || [[ "$ARCH" == "aarch64" ]]; then
          STACK_GHC_LIB_PATH="$HOME/.stack/programs/aarch64-osx/ghc-9.4.8/lib/ghc-9.4.8"
        else
          STACK_GHC_LIB_PATH="$HOME/.stack/programs/x86_64-osx/ghc-9.4.8/lib/ghc-9.4.8"
        fi
        # Ensure Haskell runtime libraries are available
        export DYLD_LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${DYLD_LIBRARY_PATH}"
        export DYLD_LIBRARY_PATH="/opt/homebrew/lib/ghc-9.4.8:$DYLD_LIBRARY_PATH"
        export DYLD_LIBRARY_PATH="/usr/local/lib/ghc-9.4.8:$DYLD_LIBRARY_PATH"
        maturin develop --release

    - name: Run tests
      run: |
        source venv/bin/activate
        # Detect architecture and set paths
        ARCH=$(uname -m)
        if [[ "$ARCH" == "arm64" ]] || [[ "$ARCH" == "aarch64" ]]; then
          STACK_GHC_LIB_PATH="$HOME/.stack/programs/aarch64-osx/ghc-9.4.8/lib/ghc-9.4.8"
        else
          STACK_GHC_LIB_PATH="$HOME/.stack/programs/x86_64-osx/ghc-9.4.8/lib/ghc-9.4.8"
        fi
        # Ensure Haskell runtime libraries are available for testing
        export DYLD_LIBRARY_PATH="${STACK_GHC_LIB_PATH}:${DYLD_LIBRARY_PATH}"
        export DYLD_LIBRARY_PATH="/opt/homebrew/lib/ghc-9.4.8:$DYLD_LIBRARY_PATH"
        export DYLD_LIBRARY_PATH="/usr/local/lib/ghc-9.4.8:$DYLD_LIBRARY_PATH"
        pytest -v duckling/tests/
        
    - name: Build wheel
      if: github.event_name == 'release'
      run: |
        source venv/bin/activate
        maturin build --release --out dist/
        
    - name: Upload wheels
      if: github.event_name == 'release'
      uses: actions/upload-artifact@v4
      with:
        name: macos-wheels-py${{ matrix.python-version }}
        path: dist/*.whl

  test-cross-platform:
    name: Test Cross-Platform Compatibility
    needs: [build-linux, build-macos]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.9', '3.11']
        
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libpcre3-dev libgmp-dev pkg-config
        
    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install pcre gmp pkg-config
        
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install Haskell Stack
      run: |
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          if ! command -v stack >/dev/null 2>&1; then
            curl -sSL https://get.haskellstack.org/ | sh
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          else
            echo "Stack already installed at $(which stack)"
          fi
          # Also install system GHC for better compatibility
          sudo apt-get install -y ghc
        else
          brew install haskell-stack ghc
        fi
        
    - name: Test build script
      run: |
        if [[ "$RUNNER_OS" == "macOS" ]]; then
          ./build-macos.sh
        else
          echo "Linux build testing would use Docker - skipping for now"
        fi

  publish:
    name: Publish to PyPI
    if: github.event_name == 'release'
    needs: [build-linux, build-macos, test-cross-platform]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all wheels
      uses: actions/download-artifact@v4
      with:
        path: dist/
        
    - name: Flatten wheel directory
      run: |
        find dist/ -name "*.whl" -exec mv {} dist/ \;
        find dist/ -type d -empty -delete
        ls -la dist/
        
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages_dir: dist/
